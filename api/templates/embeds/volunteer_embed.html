{% extends 'embed.html' %}

{% block embed_content %}
<p hidden class="success_message">Thanks for subscribing to our newsletter!</p>
<form id="taeb_server_mailing_list_form_embed" class="raleway">
    <label>Join our mailing list!</label>
    <div class="email_input_container">
        <input placeholder="Enter Email Here..." type="email" class="form-control" name="email" data-parsley-trigger="change" required="" data-parsley-errors-container="#email_errors_container">
        <button>Submit</button>
    </div>
    <div id="email_errors_container"></div>
</form>
<script type="text/javascript">
    let form = $('#taeb_server_mailing_list_form_embed');

    async function postEmail(email) {
        const response = await fetch(`https://taeb-server.vercel.app/mailing_list/users`, {
            method: "POST",
            body : new FormData(document.getElementById("taeb_server_mailing_list_form_embed"))
        }).then((response) => response.json());
        return response;
    }

    $(function () {
        form.parsley().on('form:submit', function() {
            let emailField = form.find("input").parsley();

            postEmail($("taeb_server_mailing_list_form_embed.email").val()).then(({success, message}) => {
                if (success) {
                    $("#taeb_server_mailing_list_form_embed > *").hide(400);
                    $(".success_message").removeAttr("hidden");
                }
                else {
                    emailField.addError('serverError', {
                        message: message,
                        updateClass: true
                    });
                }
            })
            return false;
        });
    });

</script>
{% endblock %}