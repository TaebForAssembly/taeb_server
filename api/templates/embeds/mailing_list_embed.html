{% extends 'base.html' %}

{% block head %}
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
<script src="https://parsleyjs.org/dist/parsley.min.js"></script>

<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Raleway:ital,wght@0,100..900;1,100..900&display=swap" rel="stylesheet">
{% endblock %}

{% block content %}
<form id="taeb_server_mailing_list_form_embed" class="raleway">
    <label>Join our mailing list!</label>
    <input placeholder="Enter Email Here..." type="email" class="form-control" name="email" data-parsley-trigger="change" required="">
    <p hidden class="success_message">Success!</p>
    <button>Submit</button>
</form>
<script type="text/javascript">
    let form = $('#taeb_server_mailing_list_form_embed');

    async function postEmail(email) {
        const response = await fetch("http://127.0.0.1:5000/mailing_list/users", {
            method: "POST",
            body : new FormData(document.getElementById("taeb_server_mailing_list_form_embed"))
        }).then((response) => response.json());
        console.log(response);
        return response;
    }

    $(function () {
        form.parsley().on('form:submit', function() {
            let emailField = form.find("input").parsley();

            postEmail($("taeb_server_mailing_list_form_embed.email").val()).then(({success, message}) => {
                if (success) {
                    console.log("success");
                    $("#taeb_server_mailing_list_form_embed > input[type=email]").hide();
                    $("#taeb_server_mailing_list_form_embed > .success_message").removeAttr("hidden");
                }
                else {
                    emailField.addError('serverError', {
                        message: message,
                        updateClass: true
                    });
                }
            })
            return false;
        });
    });

</script>
{% endblock %}